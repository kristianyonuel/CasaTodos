{% extends "base.html" %}

{% block title %}Weekly Leaderboard - La Casa de Todos{% endblock %}

{% block head %}
    <style>
        .weekly-leaderboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .week-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .leaderboard-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .rank-1 {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .rank-2 {
            background: #e2e3e5;
            border-left: 4px solid #6c757d;
        }
        
        .rank-3 {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .monday-night-prediction {
            font-style: italic;
            color: #007bff;
        }
        
        .winner-section {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .winner-section h3 {
            color: #155724;
            margin: 0 0 10px 0;
        }
        
        .predictable-winner-section {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .games-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .games-table th,
        .games-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .games-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .game-final {
            background: #d4edda;
        }
        
        .game-live {
            background: #fff3cd;
        }
        
        .game-upcoming {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="weekly-leaderboard">
        <div class="page-header">
            <h2>üèà Weekly Leaderboard</h2>
            <p>Week {{ current_week }}, {{ current_year }} - With Monday Night Tiebreakers</p>
        </div>
        
        {% if winner_prediction %}
        <div class="predictable-winner-section">
            <h3 style="color: #1976d2; margin: 0 0 10px 0;">üéØ Winner Prediction Analysis</h3>
            <p style="font-size: 16px; font-weight: 500; margin: 0; color: #0d47a1;">{{ winner_prediction }}</p>
            
            {% if winner_analysis and winner_analysis.special_case %}
            <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800;">
                <strong>{{ winner_analysis.special_case.description }}</strong><br>
                <small style="color: #666;">
                    ‚úÖ If correct: {{ winner_analysis.special_case.if_correct }}<br>
                    ‚ùå If wrong: {{ winner_analysis.special_case.if_wrong }}
                </small>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if leaderboard and leaderboard[0].is_winner %}
        <div class="winner-section">
            <h3>üèÜ Weekly Winner</h3>
            <p><strong>{{ leaderboard[0].username }}</strong> wins Week {{ current_week }} with {{ leaderboard[0].correct_picks }} correct picks!</p>
            {% if sunday_deadline_passed and leaderboard[0].monday_tiebreaker.has_pick %}
            <p class="monday-night-prediction">
                <strong>Monday Night Pick:</strong> {{ leaderboard[0].monday_tiebreaker.selected_team or 'Unknown' }}<br>
                <strong>Score Prediction:</strong> {{ leaderboard[0].monday_tiebreaker.away_team }} {{ leaderboard[0].monday_tiebreaker.predicted_away }} - {{ leaderboard[0].monday_tiebreaker.predicted_home }} {{ leaderboard[0].monday_tiebreaker.home_team }}
            </p>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="week-selector">
            <label for="week-select">Select Week:</label>
            <select id="week-select" onchange="changeWeek()">
                {% for week_num in range(1, 19) %}
                <option value="{{ week_num }}" {% if week_num == current_week %}selected{% endif %}>Week {{ week_num }}</option>
                {% endfor %}
            </select>
            
            <label for="year-select" style="margin-left: 20px;">Year:</label>
            <select id="year-select" onchange="changeWeek()">
                <option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if current_year == 2026 %}selected{% endif %}>2026</option>
            </select>
        </div>
        
        {% if leaderboard %}
        
        <!-- Special Monday Night Tiebreaker Analysis for Week 1, 2025 -->
        {% if current_week == 1 and current_year == 2025 %}
        {% set tied_leaders = [] %}
        {% set monday_night_finished = false %}
        {% for player in leaderboard %}
            {% if player.correct_picks == 12 %}
                {% set _ = tied_leaders.append(player) %}
                {% if player.monday_tiebreaker.has_pick and player.monday_tiebreaker.is_final %}
                    {% set monday_night_finished = true %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        {% if tied_leaders|length >= 2 and not monday_night_finished %}
        <div class="tiebreaker-analysis" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 24px;">üèà MONDAY NIGHT TIEBREAKER BREAKDOWN</h3>
            <p style="text-align: center; margin-bottom: 25px; font-size: 16px; opacity: 0.9;">
                {{ tied_leaders|length }} players tied with 12 correct picks! Only those who pick the WINNING team can win the week.
            </p>
            
            {% if sunday_deadline_passed %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                {% for player in tied_leaders %}
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                    <h4 style="margin: 0 0 15px 0; color: #fff; font-size: 18px;">
                        üèÜ {{ player.username.upper() }}
                    </h4>
                    
                    {% if player.monday_tiebreaker.has_pick %}
                        {% set picked_team = player.monday_tiebreaker.selected_team %}
                        {% set pred_away = player.monday_tiebreaker.predicted_away %}
                        {% set pred_home = player.monday_tiebreaker.predicted_home %}
                        
                        <p style="margin: 5px 0; font-weight: bold;">
                            Picked: <span style="color: #ffd700;">{{ picked_team }}</span> to win
                        </p>
                        <p style="margin: 5px 0; font-size: 14px;">
                            Prediction: MIN {{ pred_away }} - {{ pred_home }} CHI
                        </p>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #ffd700; font-size: 14px;">
                                üí° WINS IF:
                            </p>
                            {% if picked_team == 'CHI' %}
                                <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.4;">
                                    ‚úÖ Chicago beats Minnesota (ANY score)<br>
                                    üéØ Optimal: MIN 19 - CHI 22<br>
                                    üìà <strong>50% chance</strong> - HUGE advantage!
                                </p>
                            {% elif picked_team == 'MIN' %}
                                {% if pred_away == 21 and pred_home >= 25 %}
                                    <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.4;">
                                        ‚úÖ Minnesota beats Chicago<br>
                                        üéØ High-scoring MIN win (close to MIN 21)<br>
                                        üìà <strong>~10% chance</strong>
                                    </p>
                                {% elif pred_away == 21 and pred_home < 25 %}
                                    <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.4;">
                                        ‚úÖ Minnesota beats Chicago<br>
                                        üéØ Very specific score (MIN 21, CHI ~25)<br>
                                        üìà <strong>~2% chance</strong> - narrow window
                                    </p>
                                {% elif pred_away <= 17 %}
                                    <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.4;">
                                        ‚úÖ Minnesota beats Chicago<br>
                                        üéØ Low-scoring MIN win (your specialty!)<br>
                                        üìà <strong>~38% chance</strong> - great position
                                    </p>
                                {% else %}
                                    <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.4;">
                                        ‚úÖ Minnesota beats Chicago<br>
                                        üéØ Score close to your prediction<br>
                                        üìà Depends on actual game score
                                    </p>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% else %}
                        <p style="margin: 5px 0; color: #ffcccb;">No Monday Night prediction</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center;">
                <h4 style="margin: 0 0 15px 0; color: #ffd700;">üéÆ BOTTOM LINE</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 13px;">
                    {% for player in tied_leaders %}
                        {% if player.monday_tiebreaker.has_pick %}
                            {% set picked_team = player.monday_tiebreaker.selected_team %}
                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                                <strong>{{ player.username }}:</strong><br>
                                {% if picked_team == 'CHI' %}
                                    "I just need Chicago to win!"
                                {% elif player.monday_tiebreaker.predicted_away <= 17 %}
                                    "I need a low-scoring MIN win"
                                {% elif player.monday_tiebreaker.predicted_home >= 27 %}
                                    "I need a high-scoring MIN win" 
                                {% else %}
                                    "I need a specific MIN win"
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 20px;">
                <p style="font-size: 18px; opacity: 0.9;">
                    üîí Monday Night predictions will be revealed after Sunday deadline passes.
                </p>
                <p style="font-size: 14px; opacity: 0.7;">
                    Tiebreaker details hidden until Sunday games deadline.
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Show tiebreaker results AFTER Monday Night game finishes -->
        {% if tied_leaders|length >= 2 and monday_night_finished %}
        <div class="tiebreaker-results" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 24px;">üèÜ MONDAY NIGHT TIEBREAKER RESOLVED!</h3>
            <p style="text-align: center; margin-bottom: 25px; font-size: 16px; opacity: 0.9;">
                The Monday Night game has finished! Here's how the tiebreaker was decided:
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                {% for player in tied_leaders %}
                {% if player.monday_tiebreaker.has_pick %}
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                    <h4 style="margin: 0 0 15px 0; color: #fff; font-size: 18px;">
                        {% if loop.index == 1 %}üèÜ{% else %}{{ loop.index }}.{% endif %} {{ player.username.upper() }}
                    </h4>
                    
                    <p style="margin: 5px 0; font-weight: bold;">
                        Picked: 
                        {% if player.monday_tiebreaker.is_correct %}
                            <span style="color: #90EE90;">{{ player.monday_tiebreaker.selected_team }}</span> ‚úÖ
                        {% else %}
                            <span style="color: #FFB6C1;">{{ player.monday_tiebreaker.selected_team }}</span> ‚ùå
                        {% endif %}
                    </p>
                    <p style="margin: 5px 0; font-size: 14px;">
                        Predicted: MIN {{ player.monday_tiebreaker.predicted_away }} - {{ player.monday_tiebreaker.predicted_home }} CHI
                    </p>
                    <p style="margin: 5px 0; font-size: 14px;">
                        Actual: MIN {{ player.monday_tiebreaker.actual_away }} - {{ player.monday_tiebreaker.actual_home }} CHI
                    </p>
                    
                    {% if player.monday_tiebreaker.is_correct %}
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <p style="margin: 0; font-size: 13px; line-height: 1.4;">
                            <strong>Tiebreaker Accuracy:</strong><br>
                            Home ¬± {{ player.monday_tiebreaker.home_diff or 0 }}, Away ¬± {{ player.monday_tiebreaker.away_diff or 0 }}
                        </p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endif %}
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Correct Picks</th>
                    <th>Wrong Picks</th>
                    <th>Win %</th>
                    <th>Monday Night Prediction</th>
                </tr>
            </thead>
            <tbody>
                {% for player in leaderboard %}
                <tr class="{% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% endif %}">
                    <td>
                        {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                    </td>
                    <td><strong>{{ player.username }}</strong></td>
                    <td>{{ player.correct_picks }}</td>
                    <td>{{ player.total_picks - player.correct_picks }}</td>
                    <td>{{ player.breakdown.win_percentage }}%</td>
                    <td class="monday-night-prediction">
                        {% if sunday_deadline_passed and player.monday_tiebreaker.has_pick %}
                            <strong>Picked: {{ player.monday_tiebreaker.selected_team or 'Unknown' }}</strong><br>
                            <small>Score Prediction: {{ player.monday_tiebreaker.away_team }} {{ player.monday_tiebreaker.predicted_away }} - {{ player.monday_tiebreaker.predicted_home }} {{ player.monday_tiebreaker.home_team }}</small>
                            {% if player.monday_tiebreaker.is_final %}
                                <br><small style="color: #666;">(Actual: {{ player.monday_tiebreaker.away_team }} {{ player.monday_tiebreaker.actual_away }} - {{ player.monday_tiebreaker.actual_home }} {{ player.monday_tiebreaker.home_team }})</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #999;">{% if sunday_deadline_passed %}No prediction{% else %}Hidden until Sunday deadline{% endif %}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-data">
            <p>No leaderboard data available for this week yet.</p>
            <a href="{{ url_for('games') }}" class="btn btn-primary">Make Your Picks</a>
        </div>
        {% endif %}
        
        {% if games %}
        <div class="games-section" style="margin-top: 40px;">
            <h3>Week {{ current_week }} Games</h3>
            <table class="games-table">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr class="{% if game.is_final %}game-final{% elif game.away_score or game.home_score %}game-live{% else %}game-upcoming{% endif %}">
                        <td>{{ game.away_team }} @ {{ game.home_team }}</td>
                        <td>{{ game.game_date.strftime('%a %m/%d %I:%M %p') if game.game_date else 'TBD' }}</td>
                        <td>
                            {% if game.is_final %}FINAL
                            {% elif game.away_score or game.home_score %}LIVE
                            {% else %}{{ game.game_date.strftime('%I:%M %p') if game.game_date else 'TBD' }}
                            {% endif %}
                        </td>
                        <td>
                            {% if game.away_score is not none and game.home_score is not none %}
                                {{ game.away_team }} {{ game.away_score }} - {{ game.home_score }} {{ game.home_team }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function changeWeek() {
            const weekSelect = document.getElementById('week-select');
            const yearSelect = document.getElementById('year-select');
            const selectedWeek = weekSelect.value;
            const selectedYear = yearSelect.value;
            window.location.href = `{{ url_for('weekly_leaderboard') }}?week=${selectedWeek}&year=${selectedYear}`;
        }
    </script>
{% endblock %}
