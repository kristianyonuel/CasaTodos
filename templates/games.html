<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Picks - La Casa de Todos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèà Week {{ current_week }} Games</h1>
            <nav class="nav">
                <a href="{{ url_for('index') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('leaderboard') }}" class="nav-link">Leaderboard</a>
                <a href="{{ url_for('rules') }}" class="nav-link">Rules</a>
                <a href="{{ url_for('logout') }}" class="nav-link logout">Logout</a>
            </nav>
        </header>

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="picks-container">
                <div class="picks-header">
                    <h2>Make Your Picks - Week {{ current_week }}</h2>
                    <p>Select the winning team for each game. Monday Night Football requires score prediction.</p>
                    <div class="week-stats">
                        <span class="stat">üìÖ Week {{ current_week }} of 18</span>
                        <span class="stat">üèà {{ total_games or 0 }} Games</span>
                        <span class="stat">‚è∞ Times shown in AST</span>
                    </div>
                    
                    <!-- Week Navigation -->
                    <div class="week-navigation">
                        <h3>Select Week:</h3>
                        <div class="week-buttons">
                            {% for week_num in range(1, 19) %}
                            <a href="{{ url_for('games', week=week_num, year=current_year) }}" 
                               class="week-btn {% if week_num == current_week %}current{% endif %} {% if week_num == current_nfl_week %}active-week{% endif %}">
                                Week {{ week_num }}
                                {% if week_num == current_nfl_week %}<span class="live-indicator">LIVE</span>{% endif %}
                            </a>
                            {% endfor %}
                        </div>
                        <div class="week-info">
                            <p><strong>Current NFL Week:</strong> {{ current_nfl_week }}</p>
                            <p><strong>Viewing:</strong> Week {{ current_week }} ({{ current_year }})</p>
                            <p><strong>All times shown in AST (Atlantic Standard Time)</strong></p>
                            {% if session.get('is_admin') %}
                            <p>
                                <a href="{{ url_for('force_create_games', week=current_week, year=current_year) }}" 
                                   class="btn btn-sm btn-secondary" onclick="return confirm('Force create games for this week?')">
                                    üîß Force Create Games
                                </a>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if games %}
                <form id="picks-form" class="picks-form">
                    <div class="games-grid">
                        {% for game in games %}
                        <div class="game-card {% if game.is_monday_night %}monday-night{% endif %} {% if game.is_thursday_night %}thursday-night{% endif %} {% if game.is_final %}final{% endif %}">
                            <div class="game-header">
                                <span class="game-time">
                                    {% if game.game_date %}
                                        {{ game.game_date.strftime('%a %m/%d %I:%M %p AST') }}
                                    {% else %}
                                        TBD
                                    {% endif %}
                                </span>
                                {% if game.is_monday_night %}
                                <span class="mnf-badge">Monday Night Football</span>
                                {% elif game.is_thursday_night %}
                                <span class="tnf-badge">Thursday Night Football</span>
                                {% endif %}
                                {% if game.is_final %}
                                <span class="final-badge">FINAL</span>
                                {% endif %}
                            </div>
                            
                            {% if game.is_final and game.home_score is not none %}
                            <!-- Show final score -->
                            <div class="final-score">
                                <div class="team-score">
                                    <span class="team-name">{{ game.away_team }}</span>
                                    <span class="score">{{ game.away_score }}</span>
                                </div>
                                <div class="vs">@</div>
                                <div class="team-score">
                                    <span class="team-name">{{ game.home_team }}</span>
                                    <span class="score">{{ game.home_score }}</span>
                                </div>
                            </div>
                            
                            <!-- Show user's pick if game is final -->
                            {% if user_picks.get(game.id) %}
                            <div class="user-pick-final">
                                <strong>Your pick:</strong> {{ user_picks.get(game.id).selected_team }}
                                {% if game.is_monday_night and user_picks.get(game.id).predicted_home_score %}
                                <br><strong>Score prediction:</strong> 
                                {{ user_picks.get(game.id).predicted_away_score }} - {{ user_picks.get(game.id).predicted_home_score }}
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% else %}
                            <!-- Show pick options -->
                            <div class="teams">
                                <div class="team away-team">
                                    <input type="radio" 
                                           name="game_{{ game.id }}" 
                                           value="{{ game.away_team }}"
                                           id="away_{{ game.id }}"
                                           {% if user_picks.get(game.id, {}).get('selected_team') == game.away_team %}checked{% endif %}>
                                    <label for="away_{{ game.id }}" class="team-option">
                                        <div class="team-info">
                                            <div class="team-name">{{ game.away_team }}</div>
                                            <div class="team-label">Away</div>
                                        </div>
                                    </label>
                                </div>
                                
                                <div class="vs">@</div>
                                
                                <div class="team home-team">
                                    <input type="radio" 
                                           name="game_{{ game.id }}" 
                                           value="{{ game.home_team }}"
                                           id="home_{{ game.id }}"
                                           {% if user_picks.get(game.id, {}).get('selected_team') == game.home_team %}checked{% endif %}>
                                    <label for="home_{{ game.id }}" class="team-option">
                                        <div class="team-info">
                                            <div class="team-name">{{ game.home_team }}</div>
                                            <div class="team-label">Home</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            {% if game.is_monday_night %}
                            <div class="score-prediction">
                                <h4>Score Prediction (Tiebreaker)</h4>
                                <div class="score-inputs">
                                    <div class="score-input">
                                        <label for="away_score_{{ game.id }}">{{ game.away_team }}</label>
                                        <input type="number" 
                                               id="away_score_{{ game.id }}" 
                                               name="away_score_{{ game.id }}"
                                               min="0" max="99"
                                               placeholder="0"
                                               value="{{ user_picks.get(game.id, {}).get('predicted_away_score', '') }}">
                                    </div>
                                    <div class="score-separator">-</div>
                                    <div class="score-input">
                                        <label for="home_score_{{ game.id }}">{{ game.home_team }}</label>
                                        <input type="number" 
                                               id="home_score_{{ game.id }}" 
                                               name="home_score_{{ game.id }}"
                                               min="0" max="99"
                                               placeholder="0"
                                               value="{{ user_picks.get(game.id, {}).get('predicted_home_score', '') }}">
                                    </div>
                                </div>
                                <small>Required for Monday Night Football tiebreaker</small>
                            </div>
                            {% endif %}
                            {% endif %}
                            
                            <input type="hidden" name="game_id" value="{{ game.id }}">
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if games and not all(game.is_final for game in games) %}
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Submit Picks</button>
                        <button type="button" class="btn btn-secondary" onclick="clearPicks()">Clear All</button>
                        <button type="button" class="btn btn-info" onclick="validatePicks()">Validate Picks</button>
                    </div>
                    {% endif %}
                </form>
                {% else %}
                <div class="no-games">
                    <h3>No games available for Week {{ current_week }}</h3>
                    <p>Games may not have been created yet.</p>
                    <div class="no-games-actions">
                        <a href="{{ url_for('games', week=current_nfl_week) }}" class="btn btn-primary">Go to Current Week</a>
                        {% if session.get('is_admin') %}
                        <a href="{{ url_for('force_create_games', week=current_week, year=current_year) }}" 
                           class="btn btn-secondary" onclick="return confirm('Create games for Week {{ current_week }}?')">
                            Create Games for This Week
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <script>
        document.getElementById('picks-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validatePicks()) {
                return;
            }
            
            const formData = new FormData(this);
            const picks = [];
            const gameIds = formData.getAll('game_id');
            
            gameIds.forEach(gameId => {
                const selectedTeam = formData.get(`game_${gameId}`);
                const homeScore = formData.get(`home_score_${gameId}`);
                const awayScore = formData.get(`away_score_${gameId}`);
                
                if (selectedTeam) {
                    picks.push({
                        game_id: gameId,
                        selected_team: selectedTeam,
                        home_score: homeScore || null,
                        away_score: awayScore || null
                    });
                }
            });
            
            if (picks.length === 0) {
                alert('Please make at least one pick before submitting.');
                return;
            }
            
            try {
                document.querySelector('.btn-primary').disabled = true;
                document.querySelector('.btn-primary').textContent = 'Submitting...';
                
                const response = await fetch('/submit_picks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ picks: picks })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Picks submitted successfully!');
                    location.reload();
                } else {
                    alert('Error submitting picks: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting picks. Please try again.');
            } finally {
                document.querySelector('.btn-primary').disabled = false;
                document.querySelector('.btn-primary').textContent = 'Submit Picks';
            }
        });
        
        function validatePicks() {
            const mondayNightGames = document.querySelectorAll('.monday-night:not(.final)');
            let valid = true;
            let errorMessage = '';
            
            mondayNightGames.forEach(gameCard => {
                const gameId = gameCard.querySelector('input[name="game_id"]').value;
                const selectedTeam = gameCard.querySelector(`input[name="game_${gameId}"]:checked`);
                const homeScore = gameCard.querySelector(`input[name="home_score_${gameId}"]`);
                const awayScore = gameCard.querySelector(`input[name="away_score_${gameId}"]`);
                
                if (selectedTeam && (!homeScore.value || !awayScore.value)) {
                    valid = false;
                    errorMessage = 'Monday Night Football games require score predictions for tiebreaker.';
                    homeScore.style.borderColor = '#dc3545';
                    awayScore.style.borderColor = '#dc3545';
                }
            });
            
            if (!valid) {
                alert(errorMessage);
            }
            
            return valid;
        }
        
        function clearPicks() {
            if (confirm('Are you sure you want to clear all picks?')) {
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = '';
                    input.style.borderColor = '';
                });
            }
        }
    </script>
</body>
</html>
