<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Picks - La Casa de Todos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèà Make Your Picks</h1>
            <nav class="nav">
                <a href="{{ url_for('index') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('leaderboard') }}" class="nav-link">Leaderboard</a>
                <a href="{{ url_for('rules') }}" class="nav-link">Rules</a>
                {% if session.get('is_admin') %}
                <a href="{{ url_for('admin') }}" class="nav-link admin">Admin</a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="nav-link logout">Logout</a>
            </nav>
        </header>

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="picks-header">
                <h2>Week {{ current_week }}, {{ current_year }}</h2>
                <div class="week-selector">
                    <label for="week-select">Select Week:</label>
                    <select id="week-select" onchange="changeWeek()">
                        {% for week_num in available_weeks %}
                        <option value="{{ week_num }}" {% if week_num == current_week %}selected{% endif %}>
                            Week {{ week_num }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="picks-summary">
                    <p><strong>Games this week:</strong> {{ total_games }}</p>
                    <p><strong>Your picks:</strong> <span id="picks-count">{{ user_picks.keys()|length }}</span>/{{ total_games }}</p>
                </div>
            </div>

            {% if total_games == 0 %}
                <div class="no-games-alert">
                    <h3>No games available for Week {{ current_week }}</h3>
                    <p>Games haven't been created yet for this week.</p>
                    {% if session.get('is_admin') %}
                        <div class="admin-actions">
                            <a href="{{ url_for('force_create_games', week=current_week, year=current_year) }}" 
                               class="btn btn-primary">Create Games for Week {{ current_week }}</a>
                            <a href="{{ url_for('admin') }}" class="btn btn-secondary">Go to Admin Panel</a>
                        </div>
                    {% else %}
                        <p>Please contact the administrator to set up games for this week.</p>
                    {% endif %}
                </div>
            {% else %}
                <div class="games-container">
                    <form id="picks-form">
                        {% for game in games %}
                        <div class="game-card" data-game-id="{{ game.id }}">
                            <div class="game-info">
                                <div class="game-date">
                                    {% if game.game_date %}
                                        {% set game_datetime = game.game_date %}
                                        {{ game_datetime.strftime('%A, %B %d') }}
                                        <br>
                                        {{ game_datetime.strftime('%I:%M %p AST') }}
                                    {% else %}
                                        TBD
                                        <br>
                                        Time TBD
                                    {% endif %}
                                    
                                    {% if game.is_thursday_night %}
                                        <span class="game-type tnf">TNF</span>
                                    {% elif game.is_monday_night %}
                                        <span class="game-type mnf">MNF</span>
                                    {% elif game.is_sunday_night %}
                                        <span class="game-type snf">SNF</span>
                                    {% endif %}
                                </div>
                                
                                <div class="teams">
                                    <div class="team away-team">
                                        <input type="radio" 
                                               name="game_{{ game.id }}" 
                                               value="{{ game.away_team }}"
                                               id="away_{{ game.id }}"
                                               {% if user_picks.get(game.id, {}).get('selected_team') == game.away_team %}checked{% endif %}>
                                        <label for="away_{{ game.id }}">{{ game.away_team }}</label>
                                    </div>
                                    
                                    <div class="vs">@</div>
                                    
                                    <div class="team home-team">
                                        <input type="radio" 
                                               name="game_{{ game.id }}" 
                                               value="{{ game.home_team }}"
                                               id="home_{{ game.id }}"
                                               {% if user_picks.get(game.id, {}).get('selected_team') == game.home_team %}checked{% endif %}>
                                        <label for="home_{{ game.id }}">{{ game.home_team }}</label>
                                    </div>
                                </div>

                                {% if game.is_monday_night %}
                                <div class="score-prediction">
                                    <h4>Score Prediction (Tiebreaker)</h4>
                                    <div class="score-inputs">
                                        <input type="number" 
                                               name="away_score_{{ game.id }}" 
                                               placeholder="Away"
                                               min="0" max="99"
                                               value="{{ user_picks.get(game.id, {}).get('predicted_away_score') or '' }}">
                                        <span>-</span>
                                        <input type="number" 
                                               name="home_score_{{ game.id }}" 
                                               placeholder="Home"
                                               min="0" max="99"
                                               value="{{ user_picks.get(game.id, {}).get('predicted_home_score') or '' }}">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="submit-section">
                            <button type="submit" class="btn btn-primary btn-large">
                                Submit All Picks
                            </button>
                            <p class="picks-info">
                                You have selected <span id="selected-count">0</span> out of {{ total_games }} games
                            </p>
                        </div>
                    </form>
                </div>
            {% endif %}
        </main>
    </div>

    <script>
        function changeWeek() {
            const weekSelect = document.getElementById('week-select');
            const selectedWeek = weekSelect.value;
            window.location.href = `{{ url_for('games') }}?week=${selectedWeek}&year={{ current_year }}`;
        }

        function updatePicksCount() {
            const selectedPicks = document.querySelectorAll('input[type="radio"]:checked').length;
            document.getElementById('selected-count').textContent = selectedPicks;
            document.getElementById('picks-count').textContent = selectedPicks;
        }

        // Update count when picks change
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                updatePicksCount();
            }
        });

        // Initial count
        document.addEventListener('DOMContentLoaded', function() {
            updatePicksCount();
        });

        // Handle form submission
        document.getElementById('picks-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const picks = [];
            const gameCards = document.querySelectorAll('.game-card');
            
            gameCards.forEach(card => {
                const gameId = card.dataset.gameId;
                const selectedTeam = card.querySelector('input[type="radio"]:checked');
                
                if (selectedTeam) {
                    const pick = {
                        game_id: parseInt(gameId),
                        selected_team: selectedTeam.value
                    };
                    
                    // Add score predictions for Monday Night games
                    const awayScoreInput = card.querySelector(`input[name="away_score_${gameId}"]`);
                    const homeScoreInput = card.querySelector(`input[name="home_score_${gameId}"]`);
                    
                    if (awayScoreInput && homeScoreInput) {
                        pick.away_score = awayScoreInput.value ? parseInt(awayScoreInput.value) : null;
                        pick.home_score = homeScoreInput.value ? parseInt(homeScoreInput.value) : null;
                    }
                    
                    picks.push(pick);
                }
            });

            if (picks.length === 0) {
                alert('Please make at least one pick before submitting.');
                return;
            }

            // Submit picks
            fetch('{{ url_for("submit_picks") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ picks: picks })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting picks: ' + error.message);
            });
        });
    </script>
</body>
</html>
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error submitting picks. Please try again.');
            }
        });
    </script>
</body>
</html>
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert(result.message || 'Picks submitted successfully!');
                            location.reload();
                        } else {
                            alert('Error submitting picks: ' + (result.error || 'Unknown error'));
                        }
                        
                    } catch (error) {
                        console.error('Error submitting picks:', error);
                        alert('Error submitting picks. Please check your connection and try
</html>
                    location.reload();
                } else {
                    alert('Error submitting picks: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting picks. Please try again.');
            } finally {
                document.querySelector('.btn-primary').disabled = false;
                document.querySelector('.btn-primary').textContent = 'Submit Picks';
            }
        });
        
        function validatePicks() {
            const mondayNightGames = document.querySelectorAll('.monday-night:not(.final)');
            let valid = true;
            let errorMessage = '';
            
            mondayNightGames.forEach(gameCard => {
                const gameId = gameCard.querySelector('input[name="game_id"]').value;
                const selectedTeam = gameCard.querySelector(`input[name="game_${gameId}"]:checked`);
                const homeScore = gameCard.querySelector(`input[name="home_score_${gameId}"]`);
                const awayScore = gameCard.querySelector(`input[name="away_score_${gameId}"]`);
                
                if (selectedTeam && (!homeScore.value || !awayScore.value)) {
                    valid = false;
                    errorMessage = 'Monday Night Football games require score predictions for tiebreaker.';
                    homeScore.style.borderColor = '#dc3545';
                    awayScore.style.borderColor = '#dc3545';
                }
            });
            
            if (!valid) {
                alert(errorMessage);
            }
            
            return valid;
        }
        
        function clearPicks() {
            if (confirm('Are you sure you want to clear all picks?')) {
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = '';
                    input.style.borderColor = '';
                });
            }
        }
    </script>
</body>
</html>
