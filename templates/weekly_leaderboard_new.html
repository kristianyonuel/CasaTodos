{% extends "base.html" %}

{% block title %}Weekly Leaderboard - La Casa de Todos{% endblock %}

{% block head %}
    <style>
        .weekly-leaderboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .week-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .leaderboard-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .rank-1 {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .rank-2 {
            background: #e2e3e5;
            border-left: 4px solid #6c757d;
        }
        
        .rank-3 {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .monday-night-prediction {
            font-style: italic;
            color: #007bff;
        }
        
        .winner-section {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .winner-section h3 {
            color: #155724;
            margin: 0 0 10px 0;
        }
        
        .predictable-winner-section {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .games-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .games-table th,
        .games-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .games-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .game-final {
            background: #d4edda;
        }
        
        .game-live {
            background: #fff3cd;
        }
        
        .game-upcoming {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="weekly-leaderboard">
        <div class="page-header">
            <h2>üèà Weekly Leaderboard</h2>
            <p>Week {{ current_week }}, {{ current_year }} - With Monday Night Tiebreakers</p>
        </div>
        
        {% if winner_prediction %}
        <div class="predictable-winner-section">
            <h3 style="color: #1976d2; margin: 0 0 10px 0;">üéØ Winner Prediction Analysis</h3>
            <p style="font-size: 16px; font-weight: 500; margin: 0; color: #0d47a1;">{{ winner_prediction }}</p>
            
            {% if winner_analysis and winner_analysis.special_case %}
            <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800;">
                <strong>{{ winner_analysis.special_case.description }}</strong><br>
                <small style="color: #666;">
                    ‚úÖ If correct: {{ winner_analysis.special_case.if_correct }}<br>
                    ‚ùå If wrong: {{ winner_analysis.special_case.if_wrong }}
                </small>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if week_winner %}
        <div class="winner-section">
            <h3>üèÜ Weekly Winner</h3>
            <p><strong>{{ week_winner.username }}</strong> wins Week {{ current_week }} with {{ week_winner.correct_picks }} correct picks!</p>
            {% if week_winner.monday_night_score %}
            <p class="monday-night-prediction">Monday Night Score Prediction: {{ week_winner.monday_night_score }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="week-selector">
            <label for="week-select">Select Week:</label>
            <select id="week-select" onchange="changeWeek()">
                {% for week_num in range(1, 19) %}
                <option value="{{ week_num }}" {% if week_num == current_week %}selected{% endif %}>Week {{ week_num }}</option>
                {% endfor %}
            </select>
            
            <label for="year-select" style="margin-left: 20px;">Year:</label>
            <select id="year-select" onchange="changeWeek()">
                <option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if current_year == 2026 %}selected{% endif %}>2026</option>
            </select>
        </div>
        
        {% if leaderboard %}
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Correct Picks</th>
                    <th>Wrong Picks</th>
                    <th>Monday Night Score</th>
                    <th>Points</th>
                </tr>
            </thead>
            <tbody>
                {% for player in leaderboard %}
                <tr class="{% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% endif %}">
                    <td>
                        {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                    </td>
                    <td><strong>{{ player.username }}</strong></td>
                    <td>{{ player.correct_picks }}</td>
                    <td>{{ player.wrong_picks }}</td>
                    <td class="monday-night-prediction">{{ player.monday_night_score or 'No prediction' }}</td>
                    <td>{{ player.total_points }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-data">
            <p>No leaderboard data available for this week yet.</p>
            <a href="{{ url_for('games') }}" class="btn btn-primary">Make Your Picks</a>
        </div>
        {% endif %}
        
        {% if games %}
        <div class="games-section" style="margin-top: 40px;">
            <h3>Week {{ current_week }} Games</h3>
            <table class="games-table">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr class="{% if game.is_final %}game-final{% elif game.away_score or game.home_score %}game-live{% else %}game-upcoming{% endif %}">
                        <td>{{ game.away_team }} @ {{ game.home_team }}</td>
                        <td>{{ game.game_date.strftime('%a %m/%d %I:%M %p') if game.game_date else 'TBD' }}</td>
                        <td>
                            {% if game.is_final %}FINAL
                            {% elif game.away_score or game.home_score %}LIVE
                            {% else %}{{ game.game_date.strftime('%I:%M %p') if game.game_date else 'TBD' }}
                            {% endif %}
                        </td>
                        <td>
                            {% if game.away_score is not none and game.home_score is not none %}
                                {{ game.away_team }} {{ game.away_score }} - {{ game.home_score }} {{ game.home_team }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <div class="export-section" style="margin-top: 30px; text-align: center;">
            <a href="{{ url_for('export_weekly_leaderboard', week=current_week, year=current_year) }}" class="btn btn-secondary">üìä Export CSV</a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function changeWeek() {
            const weekSelect = document.getElementById('week-select');
            const yearSelect = document.getElementById('year-select');
            const selectedWeek = weekSelect.value;
            const selectedYear = yearSelect.value;
            window.location.href = `{{ url_for('weekly_leaderboard') }}?week=${selectedWeek}&year=${selectedYear}`;
        }
    </script>
{% endblock %}
